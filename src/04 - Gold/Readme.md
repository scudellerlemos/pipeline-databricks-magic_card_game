# ü•á Camada Gold - Magic: The Gathering

<div align="center">

<!-- Imagem ilustrativa da tabela (adicione o link abaixo) -->
![Jace, the Mind Sculptor](https://cdn11.bigcommerce.com/s-3b5vpig99v/images/stencil/500x659/products/587617/1128758/JaceTheMindSculptor8001__01242.1671568738.jpg?c=2)

*"Na forja sagrada da Gold, insights lapidados se transformam em vis√µes estrat√©gicas para decis√µes executivas."* - Nicol Bolas, Magic: The Gathering

</div>

## üìã Vis√£o Geral

Esta pasta cont√©m os notebooks respons√°veis pela **camada Gold** do pipeline de dados do Magic: The Gathering. A camada Gold realiza o processo **AL (Analyze & Load)**, criando an√°lises executivas, m√©tricas de neg√≥cio e insights estrat√©gicos prontos para consumo executivo e tomada de decis√£o.

## üéØ Objetivo

Transformar dados enriquecidos da Silver em an√°lises executivas, m√©tricas de performance e insights estrat√©gicos na Gold (Unity Catalog/Delta), garantindo:
- **Analyze**: An√°lises pr√©-computadas e m√©tricas de neg√≥cio
- **Load**: Carregamento incremental com merge inteligente
- **Governan√ßa**: Controle e rastreabilidade via Unity Catalog
- **Performance**: Otimiza√ß√£o com Delta Lake
- **Prontid√£o Executiva**: Insights prontos para tomada de decis√£o

## üîÑ Processo AL (Analyze & Load)

### **Analyze - An√°lises Executivas e M√©tricas**
```python
# Exemplo de an√°lise executiva t√≠pica
df_analise = df_silver.groupBy("DATA_REF", "NME_SET", "NME_CARD_TYPE", "NME_RARITY") \
    .agg(
        sum("VLR_USD").cast("decimal(10,2)").alias("VALOR_TOTAL_MERCADO"),
        countDistinct("NME_CARD").cast("int").alias("QTD_CARTAS_ATIVAS"),
        avg("VLR_USD").cast("decimal(10,2)").alias("VALOR_MEDIO_CARTA"),
        expr("percentile_approx(VLR_USD, 0.5)").cast("decimal(10,2)").alias("TICKET_MEDIANA")
    )

# C√°lculo de market share
window_set = Window.partitionBy("DATA_REF")
df_analise = df_analise.withColumn(
    "MARKET_SHARE_SET",
    (col("VALOR_TOTAL_MERCADO") / sum("VALOR_TOTAL_MERCADO").over(window_set)).cast("decimal(10,4)")
)
```

### **Load - Carregamento na Gold**
```python
def load_to_gold_unity_incremental(df, table_name):
    # Merge incremental com Delta Lake
    delta_table.alias("gold").merge(
        df.alias("novo"),
        "gold.DATA_REF = novo.DATA_REF AND gold.NME_CARD = novo.NME_CARD"
    ).whenMatchedUpdateAll() \
     .whenNotMatchedInsertAll() \
     .execute()
```

## üìÅ Estrutura dos Notebooks

### üìä `TB_ANALISE_MERCADO_CARTAS_EXECUTIVO.ipynb`
- **Fonte**: Dados de cartas e pre√ßos da Silver
- **Chave**: `DATA_REF`, `NME_CARD`
- **Caracter√≠sticas**: 
  - An√°lise executiva de mercado
  - Agrega√ß√µes por segmento (set, tipo, raridade)
  - C√°lculo de market share e valoriza√ß√£o
  - Categoriza√ß√µes autom√°ticas
  - Particionamento otimizado para consultas executivas
- **Tipo**: üìä Executive Analysis (an√°lises pr√©-computadas)

### üìà `TB_METRICAS_PERFORMANCE_INVESTIMENTOS.ipynb`
- **Fonte**: Dados de cartas e pre√ßos da Silver
- **Chave**: `DATA_REF`, `NME_CARD`
- **Caracter√≠sticas**:
  - KPIs de performance e ROI
  - An√°lise de risco e volatilidade
  - M√©tricas de liquidez
  - Indicadores de investimento
  - Particionamento por per√≠odo e set
- **Tipo**: üìà Investment KPIs (m√©tricas financeiras)

### ‚è∞ `TB_ANALISE_TEMPORAL.ipynb`
- **Fonte**: Dados de cartas e pre√ßos da Silver
- **Chave**: `DATA_REF`, `NME_CARD`
- **Caracter√≠sticas**:
  - An√°lise de padr√µes temporais e sazonalidade
  - Tend√™ncias de longo prazo
  - Indicadores de momentum
  - Extra√ß√£o de componentes temporais
  - Particionamento por per√≠odo e set
- **Tipo**: ‚è∞ Temporal Analysis (padr√µes temporais)

### üö® `TB_REPORT_ALERTAS_EXECUTIVOS.ipynb`
- **Fonte**: Dados de cartas e pre√ßos da Silver
- **Chave**: `DATA_REF`, `NME_CARD`
- **Caracter√≠sticas**:
  - Sistema de alertas executivos
  - Detec√ß√£o de oportunidades e riscos
  - Prioriza√ß√£o de a√ß√µes
  - Recomenda√ß√µes autom√°ticas
  - Particionamento por per√≠odo e set
- **Tipo**: üö® Executive Alerts (sistema de alertas)

## ‚öôÔ∏è Configura√ß√µes Necess√°rias

### üîê Segredos do Databricks
Configure os seguintes segredos no scope `mtg-pipeline`:
```python
catalog_name           # Nome do cat√°logo Unity
s3_bucket             # Bucket S3 para armazenamento
s3_gold_prefix        # Prefixo da camada gold
```

### Estrutura Unity Catalog
```
{catalog_name}/
‚îî‚îÄ‚îÄ gold/
    ‚îú‚îÄ‚îÄ TB_ANALISE_MERCADO_CARTAS_EXECUTIVO
    ‚îú‚îÄ‚îÄ TB_METRICAS_PERFORMANCE_INVESTIMENTOS
    ‚îú‚îÄ‚îÄ TB_ANALISE_TEMPORAL
    ‚îî‚îÄ‚îÄ TB_REPORT_ALERTAS_EXECUTIVOS
```

## üîÑ Fluxo de Execu√ß√£o

### 1. **Setup Unity Catalog**
- Cria√ß√£o do cat√°logo e schema
- Configura√ß√£o de permiss√µes
- Verifica√ß√£o de estrutura

### 2. **An√°lise Gold**
- Agrega√ß√µes executivas e m√©tricas
- C√°lculo de KPIs e indicadores
- Aplica√ß√£o de regras de neg√≥cio
- Valida√ß√£o de dados

### 3. **Prepara√ß√£o para Merge**
- Remo√ß√£o de duplicatas
- Compatibilidade de schema
- Prepara√ß√£o de chaves de merge

### 4. **Load Incremental**
- Verifica√ß√£o de tabela existente
- Merge incremental com Delta Lake
- Cria√ß√£o/atualiza√ß√£o da tabela Unity Catalog

### 5. **Valida√ß√£o e Monitoramento**
- Contagem de registros
- Verifica√ß√£o de integridade
- Logs de processamento

### üé¥ **Flavor Text do Processamento**
*"Como um or√°culo que transforma dados em vis√µes de lucro, a camada Gold revela os segredos do mercado de cartas, oferecendo insights lapidados para decis√µes estrat√©gicas."*

## üõ°Ô∏è Controle de Qualidade

### **Valida√ß√µes Implementadas**
- ‚úÖ **Verifica√ß√£o de dados vazios**
- ‚úÖ **Remo√ß√£o de duplicatas**
- ‚úÖ **Compatibilidade de schema**
- ‚úÖ **Merge incremental**
- ‚úÖ **Arredondamento preciso** (2-4 casas decimais)
- ‚úÖ **Valida√ß√£o de m√©tricas**

### **Tratamento de Erros e Recupera√ß√£o**
- **Verifica√ß√£o de exist√™ncia**: Antes de criar/atualizar tabelas
- **Preserva√ß√£o de modifica√ß√µes**: N√£o sobrescreve altera√ß√µes customizadas
- **Rollback autom√°tico**: Em caso de falha no merge
- **Logs detalhados**: Para debugging e auditoria

### **Logs e Monitoramento**
- **Contagem de registros**: Antes e depois do processamento
- **Duplicatas removidas**: Quantidade e chave utilizada
- **Schema compat√≠vel**: Colunas utilizadas no merge
- **Tempo de execu√ß√£o**: Performance do processamento
- **Valida√ß√£o de m√©tricas**: Verifica√ß√£o de c√°lculos

## üìä Caracter√≠sticas dos Dados

### **An√°lises Executivas (TB_ANALISE_MERCADO_CARTAS_EXECUTIVO)**
- **Filtro**: Baseado em RELEASE_YEAR e RELEASE_MONTH
- **Merge**: Incremental por DATA_REF + NME_CARD
- **Particionamento**: Por DATA_REF, NME_SET, NME_CARD_TYPE, NME_RARITY
- **Arredondamento**: 2 casas para valores, 4 para percentuais
- **Tipo**: üìä Executive Analysis (an√°lises pr√©-computadas)

### **M√©tricas de Performance (TB_METRICAS_PERFORMANCE_INVESTIMENTOS)**
- **Filtro**: Baseado em RELEASE_YEAR e RELEASE_MONTH
- **Merge**: Incremental por DATA_REF + NME_CARD
- **Particionamento**: Por DATA_REF, NME_SET
- **Arredondamento**: 2 casas para valores, 4 para percentuais
- **Tipo**: üìà Investment KPIs (m√©tricas financeiras)

### **An√°lises Temporais (TB_ANALISE_TEMPORAL)**
- **Filtro**: Baseado em RELEASE_YEAR e RELEASE_MONTH
- **Merge**: Incremental por DATA_REF + NME_CARD
- **Particionamento**: Por DATA_REF, NME_SET
- **Arredondamento**: 2 casas para valores, 4 para percentuais
- **Tipo**: ‚è∞ Temporal Analysis (padr√µes temporais)

### **Alertas Executivos (TB_REPORT_ALERTAS_EXECUTIVOS)**
- **Filtro**: Baseado em RELEASE_YEAR e RELEASE_MONTH
- **Merge**: Incremental por DATA_REF + NME_CARD
- **Particionamento**: Por DATA_REF, NME_SET
- **Arredondamento**: 2 casas para valores, 4 para percentuais
- **Tipo**: üö® Executive Alerts (sistema de alertas)

### üé¥ **Flavor Text dos Dados**
*"Na Gold, cada m√©trica √© uma joia lapidada, cada insight uma vis√£o estrat√©gica, pronta para iluminar o caminho das decis√µes executivas."*

## üîß Funcionalidades Avan√ßadas

### **Modulariza√ß√£o com gold_utils.ipynb**
```python
# Importa√ß√£o do m√≥dulo utilit√°rio
%run ./gold_utils

# Configura√ß√£o via m√≥dulo
config = create_manual_config(
    catalog_name="magic_the_gathering",
    s3_bucket=get_secret("s3_bucket"),
    s3_gold_prefix="magic_the_gathering/gold"
)

# Uso do processador modularizado
processor = GoldTableProcessor(TABLE_NAME, config)
dfs = processor.load_silver_data(['cards', 'prices'])
```

### **Merge Incremental Inteligente**
```python
delta_table.alias("gold").merge(
    df.alias("novo"),
    merge_condition
).whenMatchedUpdate(set=update_actions) \
 .whenNotMatchedInsert(values=insert_actions) \
 .execute()
```

### **Compatibilidade e An√°lises de Schema**
- Detec√ß√£o autom√°tica de diferen√ßas de schema
- C√°lculos precisos com arredondamento controlado
- Agrega√ß√µes otimizadas para performance
- Preserva√ß√£o de dados existentes

### **Metadados e Propriedades das Tabelas**
- **`gold_layer`**: Identifica√ß√£o da camada
- **`data_source`**: Origem dos dados (silver_layer)
- **`last_processing_date`**: Data/hora do √∫ltimo processamento
- **`table_type`**: Tipo da tabela (gold)
- **`load_mode`**: Modo de carregamento (incremental_merge_analysis)
- **`partitioning`**: Estrat√©gia de particionamento utilizada

### **Particionamento das Tabelas**
- **An√°lises Executivas**: Particionamento por DATA_REF e dimens√µes de neg√≥cio
- **M√©tricas de Performance**: Particionamento por DATA_REF e NME_SET
- **An√°lises Temporais**: Particionamento por DATA_REF e NME_SET
- **Alertas**: Particionamento por DATA_REF e NME_SET

## üîó Pr√≥ximos Passos

Ap√≥s o processamento na Gold, os dados estar√£o dispon√≠veis para:
1. **Dashboards Executivos**: Visualiza√ß√µes e relat√≥rios
3. **Tomada de Decis√£o**: Insights estrat√©gicos

## üìä Expans√£o Futura - Tabelas Silver Restantes

### üéØ **Potencial de An√°lises Adicionais**

Atualmente, a camada Gold utiliza apenas as tabelas `TB_FATO_SILVER_CARDS` e `TB_FATO_SILVER_CARDPRICES` da Silver. Existem **5 tabelas Silver adicionais** que podem expandir significativamente as capacidades anal√≠ticas:

#### **Tabelas Silver Dispon√≠veis para Expans√£o:**
- **TB_REF_SILVER_SETS** - Metadados de cole√ß√µes e expans√µes
- **TB_REF_SILVER_TYPES** - Tipos de cartas (Criatura, Feiti√ßo, Artefato, etc.)
- **TB_REF_SILVER_SUPERTYPES** - Supertipos (Lend√°rio, B√°sico, etc.)
- **TB_REF_SILVER_SUBTYPES** - Subtipos (Humano, Drag√£o, Goblin, etc.)
- **TB_REF_SILVER_FORMATS** - Formatos de jogo (Standard, Modern, Commander, etc.)

### üèóÔ∏è **An√°lises Futuras Poss√≠veis**

#### **An√°lises por Formato de Jogo:**
- Performance de cartas por formato (Standard vs Modern vs Commander)
- An√°lise de metagame e tend√™ncias por formato
- Valoriza√ß√£o espec√≠fica por formato de jogo
- Alertas de banimentos e restri√ß√µes por formato

#### **An√°lises por Tipo e Subtipo:**
- Performance de Criaturas vs Feiti√ßos vs Artefatos
- An√°lise de tribos (Humano, Drag√£o, Goblin, etc.)
- Valoriza√ß√£o por tipo de carta
- Tend√™ncias de design e poder por tipo

#### **An√°lises por Cole√ß√£o/Set:**
- Performance de cartas por set de lan√ßamento
- An√°lise de power creep ao longo do tempo
- Valoriza√ß√£o de cartas por raridade dentro de sets
- Sazonalidade de lan√ßamentos de novos sets

### üóÑÔ∏è **Data Warehouse Completo**

Com todas as tabelas Silver dispon√≠veis, √© poss√≠vel construir um **Data Warehouse completo** seguindo o modelo Star Schema:

#### **Dimens√µes (DIM):**
- **DIM_CARTAS** - Dimens√£o de cartas com todos os atributos
- **DIM_SETS** - Dimens√£o de cole√ß√µes e expans√µes
- **DIM_TEMPO** - Dimens√£o temporal (ano, m√™s, trimestre)
- **DIM_FORMATOS** - Dimens√£o de formatos de jogo
- **DIM_TIPOS** - Dimens√£o de tipos e subtipos

#### **Fatos (FATO):**
- **FATO_PRECOS** - Fato central com pre√ßos e m√©tricas
- **FATO_PERFORMANCE** - Fato de performance e ROI
- **FATO_MERCADO** - Fato de m√©tricas de mercado

#### **Tabelas Bridge:**
- **BRIDGE_CARTA_FORMATO** - Relacionamento M:N entre cartas e formatos
- **BRIDGE_CARTA_TIPO** - Relacionamento M:N entre cartas e tipos

### üé¥ **Flavor Text da Expans√£o**
*"Como um bibliotec√°rio arcano descobrindo novos grim√≥rios, a expans√£o da camada Gold revelar√° segredos ocultos do multiverso de dados, transformando cada tabela Silver em insights estrat√©gicos de valor inestim√°vel."*


## üèóÔ∏è Engenharia de Dados

### üé¥ **Flavor Text da Engenharia**
*"Como um ourives mestre lapidando diamantes, a engenharia da Gold transforma dados em insights estrat√©gicos, cada m√©trica uma joia de valor inestim√°vel para as decis√µes executivas."*

### üéØ Princ√≠pios da Camada Gold

#### **1. An√°lise Executiva**
- ‚úÖ Transforma√ß√£o de dados em insights estrat√©gicos
- ‚úÖ M√©tricas de neg√≥cio e KPIs
- ‚úÖ Agrega√ß√µes otimizadas para consultas executivas
- ‚úÖ Categoriza√ß√µes autom√°ticas

#### **2. Incrementalidade**
- ‚úÖ Merge inteligente de dados
- ‚úÖ Preserva√ß√£o de hist√≥rico
- ‚úÖ Performance otimizada
- ‚úÖ Recupera√ß√£o de falhas

#### **3. Governan√ßa**
- ‚úÖ Unity Catalog para controle
- ‚úÖ Permiss√µes granulares
- ‚úÖ Rastreabilidade completa
- ‚úÖ Auditoria de mudan√ßas

#### **4. Qualidade**
- ‚úÖ Valida√ß√£o de integridade
- ‚úÖ Remo√ß√£o de duplicatas
- ‚úÖ Compatibilidade de schema
- ‚úÖ Logs estruturados

### üìê Regras da Camada

#### **Regra #1: An√°lises Executivas**
```python
# Agrega√ß√µes otimizadas para consultas executivas
df_analise = df.groupBy("DATA_REF", "NME_SET", "NME_CARD_TYPE", "NME_RARITY") \
    .agg(
        sum("VLR_USD").cast("decimal(10,2)").alias("VALOR_TOTAL_MERCADO"),
        countDistinct("NME_CARD").cast("int").alias("QTD_CARTAS_ATIVAS")
    )
```

#### **Regra #2: Merge Incremental**
```python
delta_table.merge(df, "gold.DATA_REF = novo.DATA_REF AND gold.NME_CARD = novo.NME_CARD")
```

#### **Regra #3: Arredondamento Preciso**
```python
# 2 casas para valores monet√°rios, 4 para percentuais
sum("VLR_USD").cast("decimal(10,2)").alias("VALOR_TOTAL_MERCADO")
(col("VALOR_TOTAL_MERCADO") / sum("VALOR_TOTAL_MERCADO").over(window)).cast("decimal(10,4)")
```

#### **Regra #4: Logs Estruturados**
```python
print(f"An√°lises executivas aplicadas: {analyses}")
print(f"Merge executado com sucesso")
```

## üé¥ Galeria Visual - Camada Gold

### üèóÔ∏è Elementos da Camada Gold
```
üíé An√°lise Executiva    üîÑ Incrementalidade    üõ°Ô∏è Governan√ßa    üìä Qualidade
```

### üëë Personagens da Gold
```
üëë Nicol Bolas    üèõÔ∏è Ugin    üêâ Dragon Lords    üßô‚Äç‚ôÇÔ∏è Planeswalkers
```

### üîß Ferramentas do Ourives
```
üíé Diamond Cutter    üè∫ Insight Vessel    üîÆ Oracle Crystal    ‚öñÔ∏è Strategy Scales
```

### üéØ Metodologias da Gold
```
üíé Executive Analysis    üîÑ Merge Mastery    üõ°Ô∏è Quality Shield    üìä Metrics Crystal
```

### üåü Propriedades M√°gicas
```
‚ú® Gold Layer    üîó Data Source    ‚è∞ Processing Time    üéÆ Load Mode
```

### üèõÔ∏è Arquitetura da Gold
```
üèõÔ∏è Unity Catalog    üóÑÔ∏è Delta Lake    üìÅ Schema Gold    üîê Governance
```

### üé¥ Tipos de An√°lises Processadas
```
üìä Executive Analysis    üìà Investment KPIs    ‚è∞ Temporal Analysis    üö® Executive Alerts
```

### üîÑ Opera√ß√µes de Merge
```
üîÑ Incremental Merge    üìä Schema Compatibility    üõ°Ô∏è Quality Validation
‚ö° Performance Optimization    üìà Data Monitoring    üîç Error Handling
```

## üìö Documenta√ß√£o Completa

### üéØ **Documenta√ß√£o Detalhada das Tabelas**
Para informa√ß√µes completas sobre cada tabela da camada Gold, incluindo schema detalhado, regras de implementa√ß√£o, particionamento e linhagem de dados, consulte nossa **documenta√ß√£o completa**:


### üìã **O que voc√™ encontrar√° na documenta√ß√£o:**
- **Schema detalhado** de todas as 4 tabelas de an√°lise
- **Regras de c√°lculo** e agrega√ß√µes
- **Estrat√©gias de particionamento** espec√≠ficas
- **Linhagem de dados** e fluxo de processamento
- **Regras de implementa√ß√£o** e m√©tricas de neg√≥cio
- **Exemplos de uso** e casos espec√≠ficos

### üé¥ **Flavor Text da Documenta√ß√£o**
*"Como um grim√≥rio sagrado que cont√©m todos os segredos da magia executiva, a documenta√ß√£o completa da camada Gold revela os mist√©rios de cada an√°lise, permitindo que os magos dos neg√≥cios dominem completamente o poder dos insights estrat√©gicos."*

## üöÄ Como Executar

### Execu√ß√£o Individual
```python
# Executar notebook espec√≠fico
TB_ANALISE_MERCADO_CARTAS_EXECUTIVO_MODULAR.py
TB_METRICAS_PERFORMANCE_INVESTIMENTOS_MODULAR.py
TB_ANALISE_TEMPORAL.py
TB_REPORT_ALERTAS_EXECUTIVOS_MODULAR.py
```

### Execu√ß√£o Sequencial
```python
# Executar todos os notebooks em ordem
TB_ANALISE_MERCADO_CARTAS_EXECUTIVO_MODULAR.py
TB_METRICAS_PERFORMANCE_INVESTIMENTOS_MODULAR.py
TB_ANALISE_TEMPORAL.py
TB_REPORT_ALERTAS_EXECUTIVOS_MODULAR.py
```

## üìã Checklist de Execu√ß√£o

- [ ] Segredos configurados no Databricks
- [ ] Permiss√µes Unity Catalog verificadas
- [ ] Cluster Spark dispon√≠vel
- [ ] Dados da Silver dispon√≠veis
- [ ] Espa√ßo em disco suficiente
- [ ] gold_utils.py configurado

## üìû Suporte

Para d√∫vidas ou problemas:
- Verificar logs de execu√ß√£o
- Consultar hist√≥rico do Delta Lake
- Revisar configura√ß√µes de segredos
- Verificar permiss√µes Unity Catalog